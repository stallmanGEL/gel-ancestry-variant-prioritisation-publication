#!/usr/bin/env Rscript

##-------------------------------------------------------------------------
## Configs + packages

source("../config/config.R")

library(tidyverse)
library(data.table)

###########################################################################
###########################################################################
###                                                                     ###
###                           FUNCTIONS                                 ###
###                                                                     ###
###########################################################################
###########################################################################

configure_roh <- function(meta, min_size = 1000000) {
  roh.list <- list()
  for (index in 1:nrow(meta)) {
    roh_bed <- meta[index, ] %>%
      pull(file_path) %>%
      gsub(".vcf.gz", ".ROH.bed", .)

    if (file.exists(roh_bed)) {
      cat(paste0(roh_bed, "\n"))
      roh.list[[index]] <- fread(roh_bed) %>%
        mutate(size = V3 - V2) %>%
        filter(size >= min_size) %>%
        summarise(participant_id = meta[index, ] %>%
                     pull("participant_id"),
                  a_roh = mean(size),
                  n_roh = nrow(.),
                  c_roh = sum(size))
    } else {
        cat("No ROH file found.\n")
    }
  }
  roh_df <- do.call("rbind", roh.list) %>%
    drop_na()
  return(roh_df)
}

###########################################################################
###########################################################################
###                                                                     ###
###                           DATA PULL                                 ###
###                                                                     ###
###########################################################################
###########################################################################

cat("Creating ROH meta-data...\n")
cat("May take a while (3-4 hours...).\n")
roh_data <- fread(paste0(out_dir, "labkey_data/meta_data.csv.gz")) %>%
  configure_roh()

###########################################################################
###########################################################################
###                                                                     ###
###                          WRITE DATA                                 ###
###                                                                     ###
###########################################################################
###########################################################################

data_dir <- paste0(out_dir, "roh_data/")

## Create directory.
dir.create(file.path(data_dir))
cat(paste0("Writing data to: ", data_dir, "\n"))

fwrite(roh_data,
       file.path(paste0(data_dir, "roh_data.csv.gz")))

###########################################################################
###########################################################################
###                                                                     ###
###                         END OF SCRIPT                               ###
###                                                                     ###
###########################################################################
###########################################################################